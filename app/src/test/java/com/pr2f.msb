me=function(){this.nextToken=this.gullet.expandNextToken()},e.switchMode=function(e){this.mode=e,this.gullet.switchMode(e)},e.parse=function(){this.gullet.beginGroup(),this.settings.colorIsTextColor&&this.gullet.macros.set("\\color","\\textcolor"),this.consume();var e=this.parseExpression(!1);return this.expect("EOF",!1),this.gullet.endGroup(),e},e.parseExpression=function(e,t){for(var r=[];;){"math"===this.mode&&this.consumeSpaces();var n=this.nextToken;if(-1!==a.endOfExpression.indexOf(n.text))break;if(t&&n.text===t)break;if(e&&tn[n.text]&&tn[n.text].infix)break;var i=this.parseAtom(t);if(!i)break;r.push(i)}return"text"===this.mode&&this.formLigatures(r),this.handleInfixNodes(r)},e.handleInfixNodes=function(e){for(var t,r=-1,n=0;n<e.length;n++){var i=Ke(e[n],"infix");if(i){if(-1!==r)throw new X("only one infix operator per group",i.token);r=n,t=i.replaceWith}}if(-1!==r&&t){var a,o,s=e.slice(0,r),l=e.slice(r+1);return a=1===s.length&&"ordgroup"===s[0].type?s[0]:{type:"ordgroup",mode:this.mode,body:s},o=1===l.length&&"ordgroup"===l[0].type?l[0]:{type:"ordgroup",mode:this.mode,body:l},["\\\\abovefrac"===t?this.callFunction(t,[a,e[r],o],[]):this.callFunction(t,[a,o],[])]}return e},e.handleSupSubscript=function(e){var t=this.nextToken,r=t.text;this.consume(),this.consumeSpaces();var n=this.parseGroup(e,!1,a.SUPSUB_GREEDINESS);if(!n)throw new X("Expected group after '"+r+"'",t);return n},e.handleUnsupportedCmd=function(){for(var e=this.nextToken.text,t=[],r=0;r<e.length;r++)t.push({type:"textord",mode:"text",text:e[r]});var n={type:"text",mode:this.mode,body:t},i={type:"color",mode:this.mode,color:this.settings.errorColor,body:[n]};return this.consume(),i},e.parseAtom=function(e){var t,r,n=this.parseGroup("atom",!1,null,e);if("text"===this.mode)return n;for(;;){this.consumeSpaces();var i=this.nextToken;if("\\limits"===i.text||"\\nolimits"===i.text){var a=Ke(n,"op");if(!a)throw new X("Limit controls must follow a math operator",i);var o="\\limits"===i.text;a.limits=o,a.alwaysHandleSupSub=!0,this.consume()}else if("^"===i.text){if(t)throw new X("Double superscript",i);t=this.handleSupSubscript("superscript")}else if("_"===i.text){if(r)throw new X("Double subscript",i);r=this.handleSupSubscript("subscript")}else if("'"===i.text){if(t)throw new X("Double superscript",i);var s={type:"textord",mode:this.mode,text:"\\prime"},l=[s];for(this.consume();"'"===this.nextToken.text;)l.push(s),this.consume();"^"===this.nextToken.text&&l.push(this.handleSupSubscript("superscript")),t={type:"ordgroup",mode:this.mode,body:l}}else{if("%"!==i.text)break;this.consumeComment()}}return t||r?{type:"supsub",mode:this.mode,base:n,sup:t,sub:r}:n},e.parseFunction=function(e,t,r){var n=this.nextToken,i=n.text,a=tn[i];if(!a)return null;if(null!=r&&a.greediness<=r)throw new X("Got function '"+i+"' with no arguments"+(t?" as "+t:""),n);if("text"===this.mode&&!a.allowedInText)throw new X("Can't use function '"+i+"' in text mode",n);if("math"===this.mode&&!1===a.allowedInMath)throw new X("Can't use function '"+i+"' in math mode",n);if(a.consumeMode){var o=this.mode;this.switchMode(a.consumeMode),this.consume(),this.switchMode(o)}else this.consume();var s=this.parseArguments(i,a),l=s.args,h=s.optArgs;return this.callFunction(i,l,h,n,e)},e.callFunction=function(e,t,r,n,i){var a={funcName:e,parser:this,token:n,breakOnTokenText:i},o=tn[e];if(o&&o.handler)return o.handler(a,t,r);throw new X("No function handler for "+e)},e.parseArguments=function(e,t){var r=t.numArgs+t.numOptionalArgs;if(0===r)return{args:[],optArgs:[]};for(var n=t.greediness,i=[],a=[],o=0;o<r;o++){var s=t.argTypes&&t.argTypes[o],l=o<t.numOptionalArgs;0<o&&!l&&this.consumeSpaces(),0!==o||l||"math"!==this.mode||this.consumeSpaces();var h=this.nextToken,m=this.parseGroupOfType("argument to '"+e+"'",s,l,n);if(!m){if(l){a.push(null);continue}throw new X("Expected group after '"+e+"'",h)}(l?a:i).push(m)}return{args:i,optArgs:a}},e.parseGroupOfType=function(e,t,r,n){switch(t){case"color":return this.parseColorGroup(r);case"size":return this.parseSizeGroup(r);case"url":return this.parseUrlGroup(r);case"math":case"text":return this.parseGroup(e,r,n,void 0,t);case"original":case null:case void 0:return this.parseGroup(e,r,n);default:throw new X("Unknown group type as "+e,this.nextToken)}},e.consumeSpaces=function(){for(;" "===this.nextToken.text;)this.consume()},e.consumeComment=function(){for(;"EOF"!==this.nextToken.text&&this.nextToken.loc&&-1===this.nextToken.loc.getSource().indexOf("\n");)this.consume();if("EOF"===this.nextToken.text&&this.settings.reportNonstrict("commentAtEnd","% comment has no terminating newline; LaTeX would fail because of commenting the end of math mode (e.g. $)"),"math"===this.mode)this.consumeSpaces();else if(this.nextToken.loc){var e=this.nextToken.loc.getSource();e.indexOf("\n")===e.length-1&&this.consumeSpaces()}},e.parseStringGroup=function(e,t,r){var n=t?"[":"{",i=t?"]":"}",a=this.nextToken;if(a.text!==n){if(t)return null;if(r&&"EOF"!==a.text&&/[^{}[\]]/.test(a.text))return this.consume(),a}var o=this.mode;this.mode="text",this.expect(n);for(var s="",l=this.nextToken,h=0,m=l;r&&0<h||this.nextToken.text!==i;){switch(this.nextToken.text){case"EOF":throw new X("Unexpected end of input in "+e,l.range(m,s));case"%":if(r)break;this.consumeComment();continue;case n:h++;break;case i:h--}s+=(m=this.nextToken).text,this.consume()}return this.mode=o,this.expect(i),l.range(m,s)},e.parseRegexGroup=function(e,t){var r=this.mode;this.mode="text";for(var n=this.nextToken,i=n,a="";"EOF"!==this.nextToken.text&&(e.test(a+this.nextToken.text)||"%"===this.nextToken.text);)"%"!==this.nextToken.text?(a+=(i=this.nextToken).text,this.consume()):this.consumeComment();if(""===a)throw new X("Invalid "+t+": '"+n.text+"'",n);return this.mode=r,n.range(i,a)},e.parseColorGroup=function(e){var t=this.parseStringGroup("color",e);if(!t)return null;var r=/^(#[a-f0-9]{3}|#?[a-f0-9]{6}|[a-z]+)$/i.exec(t.text);if(!r)throw new X("Invalid color: '"+t.text+"'",t);var n=r[0];return/^[0-9a-f]{6}$/i.test(n)&&(n="#"+n),{type:"color-token",mode:this.mode,color:n}},e.parseSizeGroup=function(e){var t,r=!1;if(!(t=e||"{"===this.nextToken.text?this.parseStringGroup("size",e):this.parseRegexGroup(/^[-+]? *(?:$|\d+|\d+\.\d*|\.\d*) *[a-z]{0,2} *$/,"size")))return null;e||0!==t.text.length||(t.text="0pt",r=!0);var n=/([-+]?) *(\d+(?:\.\d*)?|\.\d+) *([a-z]{2})/.exec(t.text);if(!n)throw new X("Invalid size: '"+t.text+"'",t);var i,a={number:+(n[1]+n[2]),unit:n[3]};if("string"!=typeof(i=a)&&(i=i.unit),!(i in Re||i in Le||"ex"===i))throw new X("Invalid unit: '"+a.unit+"'",t);return{type:"size",mode:this.mode,value:a,isBlank:r}},e.parseUrlGroup=function(e){var t=this.parseStringGroup("url",e,!0);if(!t)return null;var r=t.text.replace(/\\([#$%&~_^{}])/g,"$1"),n=/^\s*([^\\/#]*?)(?::|&#0*58|&#x0*3a)/i.exec(r);n=null!=n?n[1]:"_relative";var i=this.settings.allowedProtocols;if(!Y.contains(i,"*")&&!Y.contains(i,n))throw new X("Forbidden protocol '"+n+"'",t);return{type:"url",mode:this.mode,url:r}},e.parseGroup=function(e,t,r,n,i){var a,o=this.mode,s=this.nextToken,l=s.text;if(i&&this.switchMode(i),l===(t?"[":"{")){this.gullet.beginGroup(),this.consume();var h=this.parseExpression(!1,t?"]":"}"),m=this.nextToken;return i&&this.switchMode(o),this.gullet.endGroup(),this.expect(t?"]":"}"),{type:"ordgroup",mode:this.mode,loc:p.range(s,m),body:h}}if(t)a=null;else if(null==(a=this.parseFunction(n,e,r)||this.parseSymbol())&&"\\"===l[0]&&!bn.hasOwnProperty(l)){if(this.settings.throwOnError)throw new X("Undefined control sequence: "+l,s);a=this.handleUnsupportedCmd()}return i&&this.switchMode(o),a},e.formLigatures=function(e){for(var t=e.length-1,r=0;r<t;++r){var n=e[r],i=n.text;"-"===i&&"-"===e[r+1].text&&(r+1<t&&"-"===e[r+2].text?(e.splice(r,3,{type:"textord",mode:"text",loc:p.range(n,e[r+2]),text:"---"}),t-=2):(e.splice(r,2,{type:"textord",mode:"text",loc:p.range(n,e[r+1]),text:"--"}),t-=1)),"'"!==i&&"`"!==i||e[r+1].text!==i||(e.splice(r,2,{type:"textord",mode:"text",loc:p.range(n,e[r+1]),text:i+i}),t-=1)}},e.parseSymbol=function(){var e=this.nextToken,t=e.text;if(/^\\verb[^a-zA-Z]/.test(t)){this.consume();var r=t.slice(5),n="*"===r.charAt(0);if(n&&(r=r.slice(1)),r.length<2||r.charAt(0)!==r.slice(-1))throw new X("\\verb assertion failed --\n                    please report what input caused this bug");return{type:"verb",mode:"text",body:r=r.slice(1,-1),star:n}}if("%"===t)return this.consumeComment(),this.parseSymbol();kn.hasOwnProperty(t[0])&&!W[this.mode][t[0]]&&(this.settings.strict&&"math"===this.mode&&this.settings.reportNonstrict("unicodeTextInMathMode",'Accented Unicode text character "'+t[0]+'" used in math mode',e),t=kn[t[0]]+t.substr(1));var i,a=sn.exec(